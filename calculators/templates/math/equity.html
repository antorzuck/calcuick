{% extends 'base.html' %}
{% block title %}{{c.name}}{% endblock %}
{% block description %}{{c.description}}{% endblock %}

{% block og_title %}{{c.title}}{% endblock %}
{% block og_description %}{{c.description}}{% endblock %}

{% block twitter_title %}{{c.title}}{% endblock %}
{% block twitter_description %}{{c.description}}{% endblock %}

{% block head %}
<!-- Chart.js for visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- KaTeX for mathematical expressions -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
<style>
.calculation-card {
    transition: all 0.3s ease;
}
.equity-display {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}
.insight-card {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
}
.dark .insight-card {
    background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
}
.parameter-input {
    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.9) 100%);
}
.dark .parameter-input {
    background: linear-gradient(135deg, rgba(55,65,81,0.9) 0%, rgba(75,85,99,0.9) 100%);
}
.pulse-animation {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}
.advisor-quote {
    font-style: italic;
    position: relative;
    padding: 1rem;
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%);
    border-left: 4px solid #8b5cf6;
    border-radius: 0 8px 8px 0;
}
.equity-meter {
    width: 300px;
    height: 150px;
    position: relative;
    margin: 0 auto;
    background: linear-gradient(180deg, #8b5cf6 0%, #7c3aed 100%);
    border-radius: 150px 150px 0 0;
    overflow: hidden;
    display: flex;
    align-items: flex-end;
    justify-content: center;
}
.meter-fill {
    width: 100%;
    height: 0%;
    background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
    border-radius: 150px 150px 0 0;
    transition: height 1s ease;
    position: absolute;
    bottom: 0;
}
.meter-needle {
    position: absolute;
    bottom: 0;
    left: 50%;
    width: 4px;
    height: 120px;
    background: #1f2937;
    border-radius: 2px;
    transform-origin: bottom center;
    transform: translateX(-50%) rotate(-90deg);
    transition: transform 0.8s ease;
    z-index: 20;
}
.meter-labels {
    position: absolute;
    bottom: -40px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #6b7280;
    padding: 0 20px;
}
.drawdown-timeline {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
    border-radius: 12px;
    max-height: 300px;
    overflow-y: auto;
}
.dark .drawdown-timeline {
    background: linear-gradient(135deg, #581c87 0%, #6b21a8 100%);
}
.timeline-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 8px;
    border-left: 4px solid #8b5cf6;
    transition: all 0.3s ease;
    position: relative;
}
.dark .timeline-item {
    background: rgba(88, 28, 135, 0.8);
    border-left-color: #a855f7;
}
.timeline-item.active {
    background: rgba(139, 92, 246, 0.2);
    transform: translateX(8px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}
.timeline-item.completed {
    background: rgba(16, 185, 129, 0.2);
    border-left-color: #10b981;
}
.property-wheel {
    width: 250px;
    height: 250px;
    position: relative;
    margin: 0 auto;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
    background: conic-gradient(from 0deg, #8b5cf6 0deg var(--released-angle), #e5e7eb var(--released-angle) 360deg);
}
.property-wheel::before {
    content: '';
    width: 180px;
    height: 180px;
    background: white;
    border-radius: 50%;
    position: absolute;
    box-shadow: inset 0 4px 12px rgba(0,0,0,0.1);
}
.dark .property-wheel::before {
    background: #1f2937;
}
.property-center {
    position: absolute;
    z-index: 10;
    text-align: center;
    color: #1f2937;
}
.dark .property-center {
    color: #f9fafb;
}
.interest-compound {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.5rem;
    margin: 1rem 0;
    padding: 1rem;
    background: rgba(139, 92, 246, 0.05);
    border-radius: 8px;
}
.compound-year {
    aspect-ratio: 1;
    background: #e5e7eb;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
}
.compound-year.low {
    background: linear-gradient(45deg, #10b981 0%, #059669 100%);
    color: white;
}
.compound-year.medium {
    background: linear-gradient(45deg, #f59e0b 0%, #d97706 100%);
    color: white;
}
.compound-year.high {
    background: linear-gradient(45deg, #ef4444 0%, #dc2626 100%);
    color: white;
}
.compound-year.critical {
    background: linear-gradient(45deg, #7c2d12 0%, #991b1b 100%);
    color: white;
    animation: warning 2s infinite;
}
@keyframes warning {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
.formula-box {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    padding: 1rem;
    font-family: 'Courier New', monospace;
}
.dark .formula-box {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-color: #475569;
}
.equity-card {
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
    border: 1px solid #c4b5fd;
    transition: all 0.3s ease;
}
.dark .equity-card {
    background: linear-gradient(135deg, #581c87 0%, #6b21a8 100%);
    border-color: #8b5cf6;
}
.equity-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
}
.risk-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 0.5rem;
}
.risk-low { background: #10b981; }
.risk-medium { background: #f59e0b; }
.risk-high { background: #ef4444; }
.risk-critical { background: #7c2d12; }
.equity-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}
.breakdown-item {
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}
.breakdown-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
}
.breakdown-item:hover::before {
    left: 100%;
}
.breakdown-item:hover {
    background: rgba(139, 92, 246, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
}
.age-progress {
    width: 100%;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
    position: relative;
    margin: 0.5rem 0;
}
.progress-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 0.5s ease;
    position: relative;
}
.progress-young { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
.progress-eligible { background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); }
.progress-optimal { background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%); }
.progress-senior { background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); }
.provider-comparison {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    margin: 0.5rem 0;
    background: rgba(139, 92, 246, 0.05);
    border-radius: 8px;
    border-left: 4px solid #8b5cf6;
    transition: all 0.3s ease;
}
.provider-comparison:hover {
    background: rgba(139, 92, 246, 0.1);
    transform: translateX(4px);
}
.inheritance-impact {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid #fbbf24;
    border-radius: 6px;
    padding: 0.75rem;
    margin: 0.25rem 0;
    transition: all 0.3s ease;
}
.dark .inheritance-impact {
    background: linear-gradient(135deg, #92400e 0%, #b45309 100%);
    border-color: #f59e0b;
}
.ltv-indicator {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
    margin: 0.25rem;
    transition: all 0.3s ease;
}
.ltv-indicator:hover {
    background: rgba(139, 92, 246, 0.2);
    transform: scale(1.05);
}
</style>
{% endblock %}

{% block body %}
<!-- Main Content -->
<main class="max-w-6xl mx-auto px-4 py-8">
    <!-- Back Button -->
    <div class="mb-6">
        <button onclick="window.history.back()" class="flex items-center space-x-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
            <i data-lucide="arrow-left" class="w-5 h-5"></i>
            <span>Back to Calculators</span>
        </button>
    </div>

    <!-- Header -->
    <div class="text-center mb-12">
        <div class="w-16 h-16 bg-purple-50 dark:bg-purple-900/30 rounded-xl flex items-center justify-center mx-auto mb-6 pulse-animation">
            <i data-lucide="home" class="w-8 h-8 text-purple-600 dark:text-purple-400"></i>
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">Equity Release Drawdown Calculator</h1>
        <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
            Calculate equity release drawdown options, interest accumulation, and inheritance impact. Plan your retirement funding strategy with confidence!
        </p>
        <div class="mt-4 bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg inline-block">
            <div class="text-purple-800 dark:text-purple-300 font-medium">
                🏠 Property Equity • 💰 Flexible Drawdown • 📈 Interest Tracking • 🛡️ No Negative Equity
            </div>
        </div>
    </div>

    <!-- Calculator -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-8 shadow-lg">
        <!-- Input Section -->
        <div class="mb-8">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">Equity Release Parameters</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Input Controls -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Product Type:</label>
                        <select id="product-type" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="drawdown">Drawdown Lifetime Mortgage</option>
                            <option value="lump-sum">Lump Sum Lifetime Mortgage</option>
                            <option value="home-reversion">Home Reversion Plan</option>
                            <option value="retirement-interest">Retirement Interest Only</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Property Value (£):</label>
                            <input type="number" id="property-value" step="10000" placeholder="350000" 
                                   class="parameter-input w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Current market value</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Existing Mortgage (£):</label>
                            <input type="number" id="existing-mortgage" step="1000" placeholder="0" 
                                   class="parameter-input w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Outstanding balance</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Your Age:</label>
                            <input type="number" id="applicant-age" min="55" max="95" placeholder="65" 
                                   class="parameter-input w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Partner's Age (Optional):</label>
                            <input type="number" id="partner-age" min="55" max="95" placeholder="" 
                                   class="parameter-input w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Initial Drawdown (£):</label>
                            <input type="number" id="initial-drawdown" step="1000" placeholder="50000" 
                                   class="parameter-input w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Interest Rate (%):</label>
                            <input type="number" id="interest-rate" step="0.1" placeholder="5.5" 
                                   class="parameter-input w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg">
                        </div>
                    </div>

                    <!-- Additional Drawdowns -->
                    <div id="drawdown-section">
                        <h3 class="font-medium text-gray-900 dark:text-white mb-3">Additional Drawdowns</h3>
                        <div class="space-y-3">
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Year:</label>
                                    <input type="number" id="drawdown-year-1" min="1" max="30" placeholder="5" 
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Amount (£):</label>
                                    <input type="number" id="drawdown-amount-1" step="1000" placeholder="25000" 
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Purpose:</label>
                                    <select id="drawdown-purpose-1" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                        <option value="home-improvements">Home Improvements</option>
                                        <option value="debt-consolidation">Debt Consolidation</option>
                                        <option value="living-expenses">Living Expenses</option>
                                        <option value="gift-to-family">Gift to Family</option>
                                        <option value="investment">Investment</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div>
                                    <input type="number" id="drawdown-year-2" min="1" max="30" placeholder="10" 
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                </div>
                                <div>
                                    <input type="number" id="drawdown-amount-2" step="1000" placeholder="30000" 
                                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                </div>
                                <div>
                                    <select id="drawdown-purpose-2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                        <option value="home-improvements">Home Improvements</option>
                                        <option value="debt-consolidation">Debt Consolidation</option>
                                        <option value="living-expenses">Living Expenses</option>
                                        <option value="gift-to-family">Gift to Family</option>
                                        <option value="investment">Investment</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Property Growth -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Annual Property Growth (%):</label>
                        <input type="range" id="property-growth" min="0" max="8" step="0.5" value="2.5" 
                               class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                            <span>0%</span>
                            <span id="growth-display" class="font-medium text-purple-600">2.5%</span>
                            <span>8%</span>
                        </div>
                    </div>

                    <!-- Provider Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Provider:</label>
                        <select id="provider" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="aviva" data-rate="5.5">Aviva (5.5%)</option>
                            <option value="legal-general" data-rate="5.8">Legal & General (5.8%)</option>
                            <option value="more2life" data-rate="5.3">More2Life (5.3%)</option>
                            <option value="pure-retirement" data-rate="5.9">Pure Retirement (5.9%)</option>
                            <option value="canada-life" data-rate="5.4">Canada Life (5.4%)</option>
                            <option value="custom" data-rate="5.5">Custom Rate</option>
                        </select>
                    </div>

                    <!-- Quick Presets -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Quick Scenarios:</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="setPreset('conservative')" class="px-3 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg text-sm hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">
                                Conservative
                            </button>
                            <button onclick="setPreset('moderate')" class="px-3 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg text-sm hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">
                                Moderate
                            </button>
                            <button onclick="setPreset('aggressive')" class="px-3 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg text-sm hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">
                                Aggressive
                            </button>
                            <button onclick="setPreset('maximum')" class="px-3 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg text-sm hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-colors">
                                Maximum LTV
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Visual Representation -->
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 text-center">Property Equity Status</h3>
                        <div class="property-wheel" id="property-wheel" style="--released-angle: 120deg;">
                            <div class="property-center">
                                <div class="text-2xl font-bold" id="remaining-equity">£280K</div>
                                <div class="text-sm opacity-75">Remaining</div>
                            </div>
                        </div>
                        <div class="flex justify-center space-x-4 text-xs text-gray-600 dark:text-gray-400 mt-4">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-purple-500 rounded mr-1"></div>
                                <span>Released Equity</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-gray-300 rounded mr-1"></div>
                                <span>Remaining Equity</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Equity Depletion Meter -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 text-center">Equity Depletion Risk</h3>
                        <div class="equity-meter">
                            <div class="meter-fill" id="depletion-meter"></div>
                            <div class="meter-needle" id="depletion-needle"></div>
                            <div class="meter-labels">
                                <span>Safe</span>
                                <span>Moderate</span>
                                <span>High</span>
                                <span>Critical</span>
                            </div>
                        </div>
                        <div class="text-center mt-6">
                            <span id="risk-status" class="text-lg font-semibold text-purple-600 dark:text-purple-400 flex items-center justify-center">
                                <span class="risk-indicator risk-low"></span>
                                Low Risk
                            </span>
                        </div>
                    </div>
                    
                    <!-- Drawdown Timeline -->
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 text-center">Drawdown Schedule</h3>
                        <div class="drawdown-timeline" id="drawdown-timeline">
                            <!-- Timeline items will be generated here -->
                        </div>
                    </div>
                    
                    <!-- Formula Display -->
                    <div class="formula-box">
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Compound Interest Formula:</h4>
                        <div id="formula-display" class="text-sm text-gray-700 dark:text-gray-300">
                            <div id="katex-formula"></div>
                        </div>
                    </div>
                    
                    <!-- Equity Properties -->
                    <div class="equity-card p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Product Details:</h4>
                        <div id="equity-info" class="text-sm text-gray-700 dark:text-gray-300">
                            Type: Drawdown • Rate: Fixed • Guarantee: No Negative Equity • Currency: GBP
                        </div>
                    </div>

                    <!-- Interest Accumulation -->
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-900 dark:text-white mb-3 text-center">Interest Accumulation</h4>
                        <div class="interest-compound" id="interest-compound">
                            <!-- Interest years will be generated here -->
                        </div>
                        <div class="flex justify-center space-x-4 text-xs text-gray-600 dark:text-gray-400 mt-2">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded mr-1"></div>
                                <span>Low</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-amber-500 rounded mr-1"></div>
                                <span>Medium</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-red-500 rounded mr-1"></div>
                                <span>High</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-red-900 rounded mr-1"></div>
                                <span>Critical</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <button id="calculate-btn" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-2">
                <i data-lucide="calculator" class="w-5 h-5"></i>
                <span>Calculate Equity Release</span>
            </button>
            <button id="clear-btn" class="flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-3 px-6 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-2">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                <span>Clear</span>
            </button>
            <button id="save-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-2">
                <i data-lucide="download" class="w-5 h-5"></i>
                <span>Save Results</span>
            </button>
        </div>

        <!-- Results -->
        <div id="result-container" class="hidden">
            <!-- Equity Summary -->
            <div class="equity-display text-white rounded-lg p-6 mb-6">
                <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                    <span>Equity Release Results</span>
                    <i data-lucide="home" class="w-5 h-5"></i>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="text-center">
                        <div id="total-released" class="text-3xl font-bold mb-2">-</div>
                        <div class="text-sm opacity-90">Total Released (£)</div>
                    </div>
                    <div class="text-center">
                        <div id="final-debt" class="text-3xl font-bold mb-2">-</div>
                        <div class="text-sm opacity-90">Final Debt (£)</div>
                    </div>
                    <div class="text-center">
                        <div id="inheritance-value" class="text-3xl font-bold mb-2">-</div>
                        <div class="text-sm opacity-90">Inheritance (£)</div>
                    </div>
                    <div class="text-center">
                        <div id="ltv-ratio" class="text-3xl font-bold mb-2">-</div>
                        <div class="text-sm opacity-90">LTV Ratio (%)</div>
                    </div>
                </div>
            </div>

            <!-- Equity Breakdown -->
            <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-green-800 dark:text-green-300 mb-4 flex items-center space-x-2">
                    <i data-lucide="pie-chart" class="w-5 h-5"></i>
                    <span>Equity Breakdown</span>
                </h3>
                <div class="equity-breakdown" id="equity-breakdown">
                    <!-- Breakdown items will be generated here -->
                </div>
            </div>

            <!-- Projection Chart -->
            <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-orange-800 dark:text-orange-300 mb-4 flex items-center space-x-2">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    <span>Equity Projection</span>
                </h3>
                <div class="h-64">
                    <canvas id="projection-chart"></canvas>
                </div>
            </div>

            <!-- Advisor Quote -->
            <div class="advisor-quote mb-6">
                <p id="advisor-quote" class="text-gray-800 dark:text-gray-200 text-center">
                    "Equity release can provide financial freedom in retirement, but careful planning is essential."
                </p>
                <p class="text-right text-sm text-gray-600 dark:text-gray-400 mt-2">- Financial Advisory</p>
            </div>

            <!-- Risk Analysis -->
            <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-yellow-800 dark:text-yellow-300 mb-4 flex items-center space-x-2">
                    <i data-lucide="shield-alert" class="w-5 h-5"></i>
                    <span>Risk Analysis</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="insight-card p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center space-x-2">
                            <i data-lucide="trending-down" class="w-4 h-4"></i>
                            <span>Interest Impact</span>
                        </h4>
                        <p id="interest-impact" class="text-gray-800 dark:text-gray-200">-</p>
                    </div>
                    <div class="insight-card p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center space-x-2">
                            <i data-lucide="heart" class="w-4 h-4"></i>
                            <span>Inheritance Impact</span>
                        </h4>
                        <p id="inheritance-impact-text" class="text-gray-800 dark:text-gray-200">-</p>
                    </div>
                    <div class="insight-card p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center space-x-2">
                            <i data-lucide="home" class="w-4 h-4"></i>
                            <span>Property Risk</span>
                        </h4>
                        <p id="property-risk" class="text-gray-800 dark:text-gray-200">-</p>
                    </div>
                    <div class="insight-card p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center space-x-2">
                            <i data-lucide="clock" class="w-4 h-4"></i>
                            <span>Timing Considerations</span>
                        </h4>
                        <p id="timing-considerations" class="text-gray-800 dark:text-gray-200">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Educational Content -->
    <div class="mt-12 bg-gray-50 dark:bg-gray-800/50 rounded-xl p-8">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center space-x-2">
            <i data-lucide="book-open" class="w-6 h-6"></i>
            <span>Equity Release Guide</span>
        </h2>
        <div class="space-y-6">
            <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-2">What is Equity Release?</h3>
                <p class="text-gray-600 dark:text-gray-300 mb-2">
                    Equity release allows homeowners aged 55+ to access the equity in their property without having to sell and move. The most common type is a lifetime mortgage where interest compounds over time.
                </p>
                <div class="formula-box mt-4">
                    <div class="katex-formula">Final\ Debt = Principal \times (1 + r)^t</div>
                </div>
            </div>
            <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Types of Equity Release</h3>
                <ul class="list-disc list-inside space-y-1 text-gray-600 dark:text-gray-300 text-sm">
                    <li><strong>Drawdown Lifetime Mortgage:</strong> Release equity in stages as needed</li>
                    <li><strong>Lump Sum Lifetime Mortgage:</strong> Release all equity at once</li>
                    <li><strong>Home Reversion:</strong> Sell part/all of property to provider</li>
                    <li><strong>Retirement Interest Only:</strong> Pay interest monthly, capital on death/sale</li>
                </ul>
            </div>
            <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Key Considerations</h3>
                <ul class="list-disc list-inside space-y-1 text-gray-600 dark:text-gray-300">
                    <li><strong>No Negative Equity Guarantee:</strong> You'll never owe more than your home is worth</li>
                    <li><strong>Compound Interest:</strong> Interest is added to the loan and compounds annually</li>
                    <li><strong>Inheritance Impact:</strong> Reduces the value of your estate</li>
                    <li><strong>Right to Remain:</strong> You can stay in your home for life</li>
                </ul>
            </div>
            <div>
                <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Important Safeguards</h3>
                <ul class="list-disc list-inside space-y-1 text-gray-600 dark:text-gray-300">
                    <li>All providers must be FCA regulated</li>
                    <li>Independent financial advice is mandatory</li>
                    <li>Cooling-off period of 14 days minimum</li>
                    <li>No negative equity guarantee protection</li>
                    <li>Right to make voluntary repayments (conditions apply)</li>
                </ul>
            </div>
        </div>
    </div>
</main>

<!-- JavaScript -->
<script>
// Equity release presets
const presets = {
    'conservative': {
        productType: 'drawdown',
        propertyValue: 300000,
        existingMortgage: 0,
        applicantAge: 70,
        partnerAge: 68,
        initialDrawdown: 30000,
        interestRate: 5.5,
        drawdownYear1: 5,
        drawdownAmount1: 15000,
        drawdownYear2: 10,
        drawdownAmount2: 20000,
        propertyGrowth: 2.5,
        provider: 'aviva'
    },
    'moderate': {
        productType: 'drawdown',
        propertyValue: 400000,
        existingMortgage: 50000,
        applicantAge: 65,
        partnerAge: 63,
        initialDrawdown: 60000,
        interestRate: 5.8,
        drawdownYear1: 3,
        drawdownAmount1: 25000,
        drawdownYear2: 8,
        drawdownAmount2: 35000,
        propertyGrowth: 3.0,
        provider: 'legal-general'
    },
    'aggressive': {
        productType: 'drawdown',
        propertyValue: 500000,
        existingMortgage: 100000,
        applicantAge: 60,
        partnerAge: 58,
        initialDrawdown: 80000,
        interestRate: 5.9,
        drawdownYear1: 2,
        drawdownAmount1: 40000,
        drawdownYear2: 6,
        drawdownAmount2: 50000,
        propertyGrowth: 3.5,
        provider: 'pure-retirement'
    },
    'maximum': {
        productType: 'lump-sum',
        propertyValue: 600000,
        existingMortgage: 0,
        applicantAge: 75,
        partnerAge: 73,
        initialDrawdown: 180000,
        interestRate: 5.4,
        drawdownYear1: '',
        drawdownAmount1: '',
        drawdownYear2: '',
        drawdownAmount2: '',
        propertyGrowth: 2.0,
        provider: 'canada-life'
    }
};

// Advisor quotes for different scenarios
const advisorQuotes = [
    { condition: 'low-risk', quote: "Equity release can provide financial freedom in retirement, but careful planning is essential.", author: "Financial Advisory" },
    { condition: 'moderate-risk', quote: "Consider the long-term impact on your estate when planning equity release.", author: "Estate Planning" },
    { condition: 'high-risk', quote: "High LTV ratios require careful monitoring of property values and interest rates.", author: "Risk Management" },
    { condition: 'inheritance-impact', quote: "Discuss equity release plans with your family to manage expectations.", author: "Family Finance" }
];

let projectionChart = null;

// Initialize calculator
function initCalculator() {
    console.log('Initializing Equity Release Calculator...');
    setupEventListeners();
    updateVisualization();
    updateFormula();
    generateDrawdownTimeline();
    generateInterestCompound();
    clearCalculator();
}

// Setup event listeners
function setupEventListeners() {
    console.log('Setting up event listeners...');
    const calculateBtn = document.getElementById('calculate-btn');
    const clearBtn = document.getElementById('clear-btn');
    const saveBtn = document.getElementById('save-btn');
    const productType = document.getElementById('product-type');
    const propertyGrowth = document.getElementById('property-growth');
    const provider = document.getElementById('provider');

    if (calculateBtn) {
        calculateBtn.addEventListener('click', calculateEquityRelease);
    }

    if (clearBtn) {
        clearBtn.addEventListener('click', clearCalculator);
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', saveResults);
    }

    if (productType) {
        productType.addEventListener('change', () => {
            updateFormula();
            generateDrawdownTimeline();
        });
    }

    if (propertyGrowth) {
        propertyGrowth.addEventListener('input', (e) => {
            document.getElementById('growth-display').textContent = `${e.target.value}%`;
            if (hasValidInputs()) {
                calculateEquityRelease();
            }
        });
    }

    if (provider) {
        provider.addEventListener('change', (e) => {
            const rate = e.target.selectedOptions[0].dataset.rate;
            if (rate && e.target.value !== 'custom') {
                document.getElementById('interest-rate').value = rate;
            }
            if (hasValidInputs()) {
                calculateEquityRelease();
            }
        });
    }

    // Add input listeners for real-time updates
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('parameter-input')) {
            updatePropertyWheel();
            updateDepletionMeter();
            if (hasValidInputs()) {
                calculateEquityRelease();
            }
        }
    });
}

// Check if we have valid inputs
function hasValidInputs() {
    const propertyValue = parseFloat(document.getElementById('property-value').value);
    const applicantAge = parseInt(document.getElementById('applicant-age').value);
    const initialDrawdown = parseFloat(document.getElementById('initial-drawdown').value);
    const interestRate = parseFloat(document.getElementById('interest-rate').value);
    
    return propertyValue > 0 && applicantAge >= 55 && initialDrawdown > 0 && interestRate > 0;
}

// Set preset values
function setPreset(presetKey) {
    console.log(`Setting preset: ${presetKey}`);
    const preset = presets[presetKey];
    if (!preset) {
        console.error(`Preset ${presetKey} not found`);
        return;
    }

    try {
        document.getElementById('product-type').value = preset.productType;
        document.getElementById('property-value').value = preset.propertyValue;
        document.getElementById('existing-mortgage').value = preset.existingMortgage;
        document.getElementById('applicant-age').value = preset.applicantAge;
        document.getElementById('partner-age').value = preset.partnerAge;
        document.getElementById('initial-drawdown').value = preset.initialDrawdown;
        document.getElementById('interest-rate').value = preset.interestRate;
        document.getElementById('drawdown-year-1').value = preset.drawdownYear1;
        document.getElementById('drawdown-amount-1').value = preset.drawdownAmount1;
        document.getElementById('drawdown-year-2').value = preset.drawdownYear2;
        document.getElementById('drawdown-amount-2').value = preset.drawdownAmount2;
        document.getElementById('property-growth').value = preset.propertyGrowth;
        document.getElementById('provider').value = preset.provider;

        // Update displays
        document.getElementById('growth-display').textContent = `${preset.propertyGrowth}%`;

        console.log('Preset values set, updating visualizations...');
        
        // Force update all UI elements
        setTimeout(() => {
            updateVisualization();
            updateFormula();
            generateDrawdownTimeline();
            generateInterestCompound();
            calculateEquityRelease();
        }, 50);
    } catch (error) {
        console.error('Error setting preset:', error);
    }
}

// Update visualization
function updateVisualization() {
    updatePropertyWheel();
    updateDepletionMeter();
    generateDrawdownTimeline();
    generateInterestCompound();
}

// Update property wheel
function updatePropertyWheel() {
    const propertyValue = parseFloat(document.getElementById('property-value').value) || 350000;
    const initialDrawdown = parseFloat(document.getElementById('initial-drawdown').value) || 50000;
    const existingMortgage = parseFloat(document.getElementById('existing-mortgage').value) || 0;
    
    const availableEquity = propertyValue - existingMortgage;
    const releasedEquity = initialDrawdown;
    const remainingEquity = availableEquity - releasedEquity;
    
    const releasedPercentage = (releasedEquity / availableEquity) * 100;
    const releasedAngle = (releasedPercentage / 100) * 360;
    
    const wheel = document.getElementById('property-wheel');
    wheel.style.setProperty('--released-angle', `${releasedAngle}deg`);
    
    document.getElementById('remaining-equity').textContent = `£${Math.round(remainingEquity / 1000)}K`;
}

// Update depletion meter
function updateDepletionMeter() {
    const propertyValue = parseFloat(document.getElementById('property-value').value) || 350000;
    const initialDrawdown = parseFloat(document.getElementById('initial-drawdown').value) || 50000;
    const interestRate = parseFloat(document.getElementById('interest-rate').value) || 5.5;
    
    // Calculate LTV ratio
    const ltvRatio = (initialDrawdown / propertyValue) * 100;
    
    const depletionMeter = document.getElementById('depletion-meter');
    const depletionNeedle = document.getElementById('depletion-needle');
    const riskStatus = document.getElementById('risk-status');
    
    // Update meter fill (0-100% range)
    const fillHeight = Math.min(ltvRatio * 2, 100); // Scale LTV to meter
    depletionMeter.style.height = `${fillHeight}%`;
    
    // Update needle rotation (-90 to +90 degrees)
    const needleRotation = -90 + (ltvRatio / 50 * 180); // 50% LTV = full scale
    depletionNeedle.style.transform = `translateX(-50%) rotate(${needleRotation}deg)`;
    
    // Update status
    let status = '';
    let indicator = '';
    if (ltvRatio >= 40) {
        status = 'Critical Risk';
        indicator = '<span class="risk-indicator risk-critical"></span>';
        depletionMeter.className = 'meter-fill';
        depletionMeter.style.background = 'linear-gradient(180deg, #7c2d12 0%, #991b1b 100%)';
    } else if (ltvRatio >= 30) {
        status = 'High Risk';
        indicator = '<span class="risk-indicator risk-high"></span>';
        depletionMeter.className = 'meter-fill';
        depletionMeter.style.background = 'linear-gradient(180deg, #ef4444 0%, #dc2626 100%)';
    } else if (ltvRatio >= 20) {
        status = 'Moderate Risk';
        indicator = '<span class="risk-indicator risk-medium"></span>';
        depletionMeter.className = 'meter-fill';
        depletionMeter.style.background = 'linear-gradient(180deg, #f59e0b 0%, #d97706 100%)';
    } else {
        status = 'Low Risk';
        indicator = '<span class="risk-indicator risk-low"></span>';
        depletionMeter.className = 'meter-fill';
        depletionMeter.style.background = 'linear-gradient(180deg, #10b981 0%, #059669 100%)';
    }
    
    riskStatus.innerHTML = `${indicator}${status}`;
}

// Generate drawdown timeline
function generateDrawdownTimeline() {
    const timeline = document.getElementById('drawdown-timeline');
    timeline.innerHTML = '';
    
    const productType = document.getElementById('product-type').value;
    const initialDrawdown = parseFloat(document.getElementById('initial-drawdown').value) || 50000;
    const year1 = parseInt(document.getElementById('drawdown-year-1').value);
    const amount1 = parseFloat(document.getElementById('drawdown-amount-1').value);
    const year2 = parseInt(document.getElementById('drawdown-year-2').value);
    const amount2 = parseFloat(document.getElementById('drawdown-amount-2').value);
    
    // Initial drawdown
    const initialItem = document.createElement('div');
    initialItem.className = 'timeline-item completed';
    initialItem.innerHTML = `
        <div>
            <span class="font-medium">Year 0 - Initial Release</span>
            <div class="text-xs text-gray-500">Product setup</div>
        </div>
        <span class="font-bold text-purple-600 dark:text-purple-400">£${initialDrawdown.toLocaleString()}</span>
    `;
    timeline.appendChild(initialItem);
    
    // Additional drawdowns (only for drawdown products)
    if (productType === 'drawdown') {
        if (year1 && amount1) {
            const item1 = document.createElement('div');
            item1.className = 'timeline-item';
            item1.innerHTML = `
                <div>
                    <span class="font-medium">Year ${year1} - Additional Release</span>
                    <div class="text-xs text-gray-500">${document.getElementById('drawdown-purpose-1').value.replace('-', ' ')}</div>
                </div>
                <span class="font-bold text-purple-600 dark:text-purple-400">£${amount1.toLocaleString()}</span>
            `;
            timeline.appendChild(item1);
        }
        
        if (year2 && amount2) {
            const item2 = document.createElement('div');
            item2.className = 'timeline-item';
            item2.innerHTML = `
                <div>
                    <span class="font-medium">Year ${year2} - Additional Release</span>
                    <div class="text-xs text-gray-500">${document.getElementById('drawdown-purpose-2').value.replace('-', ' ')}</div>
                </div>
                <span class="font-bold text-purple-600 dark:text-purple-400">£${amount2.toLocaleString()}</span>
            `;
            timeline.appendChild(item2);
        }
    }
    
    // Final settlement
    const finalItem = document.createElement('div');
    finalItem.className = 'timeline-item';
    finalItem.innerHTML = `
        <div>
            <span class="font-medium">End of Plan</span>
            <div class="text-xs text-gray-500">Sale or inheritance</div>
        </div>
        <span class="font-bold text-gray-600 dark:text-gray-400">Settlement</span>
    `;
    timeline.appendChild(finalItem);
}

// Generate interest compound visualization
function generateInterestCompound() {
    const compound = document.getElementById('interest-compound');
    compound.innerHTML = '';
    
    const initialDrawdown = parseFloat(document.getElementById('initial-drawdown').value) || 50000;
    const interestRate = parseFloat(document.getElementById('interest-rate').value) || 5.5;
    
    for (let year = 1; year <= 20; year++) {
        const yearDiv = document.createElement('div');
        yearDiv.className = 'compound-year';
        
        // Calculate compound interest
        const debt = initialDrawdown * Math.pow(1 + interestRate / 100, year);
        const debtRatio = debt / initialDrawdown;
        
        let className = 'low';
        if (debtRatio >= 4) className = 'critical';
        else if (debtRatio >= 3) className = 'high';
        else if (debtRatio >= 2) className = 'medium';
        
        yearDiv.classList.add(className);
        yearDiv.innerHTML = `
            <div class="font-bold">${year}</div>
            <div class="text-xs">${debtRatio.toFixed(1)}x</div>
        `;
        
        compound.appendChild(yearDiv);
    }
}

// Update formula display
function updateFormula() {
    const productType = document.getElementById('product-type').value;
    const katexElement = document.getElementById('katex-formula');

    let formula = '';
    switch (productType) {
        case 'drawdown':
            formula = 'Debt = \\sum_{i} Principal_i \\times (1 + r)^{t_i}';
            break;
        case 'lump-sum':
            formula = 'Final\\ Debt = Principal \\times (1 + r)^t';
            break;
        case 'home-reversion':
            formula = 'Sale\\ Proceeds = Property\\ Value \\times (1 - Percentage\\ Sold)';
            break;
        case 'retirement-interest':
            formula = 'Monthly\\ Payment = \\frac{Principal \\times r}{12}';
            break;
        default:
            formula = 'Compound\\ Interest = P(1 + r)^t';
    }

    try {
        katex.render(formula, katexElement, {
            throwOnError: false,
            displayMode: false
        });
    } catch (error) {
        katexElement.textContent = formula;
    }
}

// Calculate equity release
function calculateEquityRelease() {
    console.log('Calculating equity release...');
    try {
        const propertyValue = parseFloat(document.getElementById('property-value').value) || 0;
        const existingMortgage = parseFloat(document.getElementById('existing-mortgage').value) || 0;
        const applicantAge = parseInt(document.getElementById('applicant-age').value) || 65;
        const partnerAge = parseInt(document.getElementById('partner-age').value) || 0;
        const initialDrawdown = parseFloat(document.getElementById('initial-drawdown').value) || 0;
        const interestRate = parseFloat(document.getElementById('interest-rate').value) || 0;
        const propertyGrowth = parseFloat(document.getElementById('property-growth').value) || 2.5;
        const productType = document.getElementById('product-type').value;

        if (propertyValue <= 0 || applicantAge < 55 || initialDrawdown <= 0 || interestRate <= 0) {
            console.log('Please enter valid equity release parameters');
            return;
        }

        // Calculate maximum LTV based on age
        const youngestAge = partnerAge > 0 ? Math.min(applicantAge, partnerAge) : applicantAge;
        const maxLTV = calculateMaxLTV(youngestAge, productType);
        
        // Calculate available equity
        const availableEquity = propertyValue - existingMortgage;
        const maxRelease = availableEquity * (maxLTV / 100);
        
        // Get additional drawdowns
        const year1 = parseInt(document.getElementById('drawdown-year-1').value) || 0;
        const amount1 = parseFloat(document.getElementById('drawdown-amount-1').value) || 0;
        const year2 = parseInt(document.getElementById('drawdown-year-2').value) || 0;
        const amount2 = parseFloat(document.getElementById('drawdown-amount-2').value) || 0;
        
        // Calculate total released over time
        let totalReleased = initialDrawdown;
        if (productType === 'drawdown') {
            if (year1 > 0 && amount1 > 0) totalReleased += amount1;
            if (year2 > 0 && amount2 > 0) totalReleased += amount2;
        }
        
        // Calculate compound interest for each drawdown
        const projectionYears = 25;
        let finalDebt = 0;
        
        // Initial drawdown compounds for full period
        finalDebt += initialDrawdown * Math.pow(1 + interestRate / 100, projectionYears);
        
        // Additional drawdowns compound for remaining periods
        if (productType === 'drawdown') {
            if (year1 > 0 && amount1 > 0) {
                finalDebt += amount1 * Math.pow(1 + interestRate / 100, projectionYears - year1);
            }
            if (year2 > 0 && amount2 > 0) {
                finalDebt += amount2 * Math.pow(1 + interestRate / 100, projectionYears - year2);
            }
        }
        
        // Calculate future property value
        const futurePropertyValue = propertyValue * Math.pow(1 + propertyGrowth / 100, projectionYears);
        
        // Calculate inheritance value (with no negative equity guarantee)
        const inheritanceValue = Math.max(0, futurePropertyValue - finalDebt);
        
        // Calculate LTV ratio
        const currentLTV = (totalReleased / propertyValue) * 100;
        
        // Generate breakdown
        const breakdown = generateEquityBreakdown(propertyValue, totalReleased, finalDebt, inheritanceValue);
        
        // Calculate risk analysis
        const analysis = calculateRiskAnalysis(currentLTV, interestRate, propertyGrowth, applicantAge);

        // Update display
        updateResults({
            totalReleased,
            finalDebt,
            inheritanceValue,
            ltvRatio: currentLTV,
            maxRelease,
            availableEquity
        }, breakdown, analysis);

        // Create chart
        createProjectionChart(propertyValue, totalReleased, interestRate, propertyGrowth, projectionYears);

        // Show results
        const resultContainer = document.getElementById('result-container');
        resultContainer.classList.remove('hidden');

        setTimeout(() => {
            resultContainer.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }, 100);

        console.log('Equity release calculations completed successfully');
    } catch (error) {
        console.error('Error calculating equity release:', error);
        alert('An error occurred while calculating. Please check your inputs.');
    }
}

// Calculate maximum LTV based on age and product type
function calculateMaxLTV(age, productType) {
    let baseLTV = 0;
    
    // Age-based LTV calculation
    if (age >= 85) baseLTV = 55;
    else if (age >= 80) baseLTV = 50;
    else if (age >= 75) baseLTV = 45;
    else if (age >= 70) baseLTV = 40;
    else if (age >= 65) baseLTV = 35;
    else if (age >= 60) baseLTV = 30;
    else baseLTV = 25;
    
    // Product type adjustments
    switch (productType) {
        case 'drawdown':
            return baseLTV * 0.9; // Slightly lower for drawdown
        case 'home-reversion':
            return baseLTV * 1.2; // Higher for home reversion
        case 'retirement-interest':
            return baseLTV * 0.8; // Lower for RIO
        default:
            return baseLTV;
    }
}

// Generate equity breakdown
function generateEquityBreakdown(propertyValue, totalReleased, finalDebt, inheritanceValue) {
    return [
        {
            label: 'Property Value',
            value: propertyValue,
            percentage: 100,
            description: 'Current market valuation'
        },
        {
            label: 'Total Released',
            value: totalReleased,
            percentage: (totalReleased / propertyValue * 100).toFixed(1),
            description: 'Cash received to date'
        },
        {
            label: 'Projected Debt',
            value: finalDebt,
            percentage: (finalDebt / propertyValue * 100).toFixed(1),
            description: 'Final amount owed (25 years)'
        },
        {
            label: 'Inheritance Value',
            value: inheritanceValue,
            percentage: (inheritanceValue / propertyValue * 100).toFixed(1),
            description: 'Estimated remaining equity'
        }
    ];
}

// Calculate risk analysis
function calculateRiskAnalysis(ltvRatio, interestRate, propertyGrowth, applicantAge) {
    let interestImpact = '';
    if (interestRate >= 6.5) {
        interestImpact = 'High interest rate will significantly compound debt over time. Consider fixed rate options.';
    } else if (interestRate >= 5.5) {
        interestImpact = 'Moderate interest rate. Debt will double approximately every 13 years.';
    } else {
        interestImpact = 'Relatively low interest rate provides better long-term value retention.';
    }

    let inheritanceImpact = '';
    if (ltvRatio >= 40) {
        inheritanceImpact = 'Significant impact on inheritance. Consider discussing with family members.';
    } else if (ltvRatio >= 25) {
        inheritanceImpact = 'Moderate impact on inheritance. Some equity should remain for beneficiaries.';
    } else {
        inheritanceImpact = 'Limited impact on inheritance. Substantial equity likely to remain.';
    }

    let propertyRisk = '';
    if (propertyGrowth <= 1.5) {
        propertyRisk = 'Low property growth assumptions increase risk of negative equity over time.';
    } else if (propertyGrowth <= 3.0) {
        propertyRisk = 'Moderate property growth should maintain equity buffer against debt accumulation.';
    } else {
        propertyRisk = 'Strong property growth projections provide good protection against debt accumulation.';
    }

    let timingConsiderations = '';
    if (applicantAge < 60) {
        timingConsiderations = 'Young age means longer compound period. Consider delaying if possible.';
    } else if (applicantAge < 70) {
        timingConsiderations = 'Good timing for equity release with reasonable compound period.';
    } else {
        timingConsiderations = 'Optimal age for equity release with shorter compound interest period.';
    }

    return {
        interestImpact,
        inheritanceImpact: inheritanceImpact,
        propertyRisk,
        timingConsiderations
    };
}

// Update results display
function updateResults(metrics, breakdown, analysis) {
    // Update summary
    document.getElementById('total-released').textContent = `£${metrics.totalReleased.toLocaleString()}`;
    document.getElementById('final-debt').textContent = `£${metrics.finalDebt.toLocaleString()}`;
    document.getElementById('inheritance-value').textContent = `£${metrics.inheritanceValue.toLocaleString()}`;
    document.getElementById('ltv-ratio').textContent = `${metrics.ltvRatio.toFixed(1)}%`;

    // Update breakdown
    const breakdownContainer = document.getElementById('equity-breakdown');
    breakdownContainer.innerHTML = '';
    
    breakdown.forEach(item => {
        const breakdownDiv = document.createElement('div');
        breakdownDiv.className = 'breakdown-item';
        breakdownDiv.innerHTML = `
            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">${item.label}</h4>
            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400 mb-2">
                £${item.value.toLocaleString()}
            </div>
            <div class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">
                ${item.percentage}% of property
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400">${item.description}</p>
        `;
        breakdownContainer.appendChild(breakdownDiv);
    });

    // Update analysis
    document.getElementById('interest-impact').textContent = analysis.interestImpact;
    document.getElementById('inheritance-impact-text').textContent = analysis.inheritanceImpact;
    document.getElementById('property-risk').textContent = analysis.propertyRisk;
    document.getElementById('timing-considerations').textContent = analysis.timingConsiderations;

    // Update advisor quote
    const quote = getAdvisorQuote(metrics.ltvRatio, metrics.inheritanceValue);
    document.getElementById('advisor-quote').textContent = `"${quote.quote}"`;
    document.querySelector('.advisor-quote p:last-child').textContent = `- ${quote.author}`;
}

// Get advisor quote based on metrics
function getAdvisorQuote(ltvRatio, inheritanceValue) {
    if (ltvRatio >= 35) {
        return advisorQuotes.find(q => q.condition === 'high-risk');
    } else if (inheritanceValue < 100000) {
        return advisorQuotes.find(q => q.condition === 'inheritance-impact');
    } else if (ltvRatio >= 20) {
        return advisorQuotes.find(q => q.condition === 'moderate-risk');
    } else {
        return advisorQuotes.find(q => q.condition === 'low-risk');
    }
}

// Create projection chart
function createProjectionChart(propertyValue, totalReleased, interestRate, propertyGrowth, years) {
    console.log('Creating projection chart...');
    try {
        const ctx = document.getElementById('projection-chart');
        if (!ctx) {
            throw new Error('Chart canvas not found');
        }

        if (projectionChart) {
            projectionChart.destroy();
        }

        // Generate data points for projection
        const yearLabels = [];
        const propertyValues = [];
        const debtValues = [];
        const equityValues = [];

        for (let year = 0; year <= years; year += 5) {
            yearLabels.push(`Year ${year}`);
            
            // Property value with growth
            const futurePropertyValue = propertyValue * Math.pow(1 + propertyGrowth / 100, year);
            propertyValues.push(futurePropertyValue);
            
            // Debt accumulation
            const debtValue = totalReleased * Math.pow(1 + interestRate / 100, year);
            debtValues.push(debtValue);
            
            // Remaining equity
            const remainingEquity = Math.max(0, futurePropertyValue - debtValue);
            equityValues.push(remainingEquity);
        }

        projectionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: yearLabels,
                datasets: [
                    {
                        label: 'Property Value',
                        data: propertyValues,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    },
                    {
                        label: 'Debt Accumulation',
                        data: debtValues,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    },
                    {
                        label: 'Remaining Equity',
                        data: equityValues,
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Equity Release Projection',
                        color: '#1f2937',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: £${context.parsed.y.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Value (£)',
                            color: '#374151',
                            font: { size: 12, weight: '500' }
                        },
                        ticks: {
                            color: '#6b7280',
                            callback: function(value) {
                                return '£' + (value / 1000).toFixed(0) + 'K';
                            }
                        },
                        grid: {
                            color: '#e5e7eb'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time Period',
                            color: '#374151',
                            font: { size: 12, weight: '500' }
                        },
                        ticks: {
                            color: '#6b7280'
                        },
                        grid: {
                            color: '#e5e7eb'
                        }
                    }
                }
            }
        });

        console.log('Projection chart created successfully');
    } catch (error) {
        console.error('Error creating projection chart:', error);
    }
}

// Save results function
function saveResults() {
    try {
        const totalReleased = document.getElementById('total-released').textContent;
        const finalDebt = document.getElementById('final-debt').textContent;
        const propertyValue = document.getElementById('property-value').value;
        const productType = document.getElementById('product-type').value;
        
        const results = `
Equity Release Calculator Results
=================================

Property Details:
Property Value: £${propertyValue}
Product Type: ${productType}
Applicant Age: ${document.getElementById('applicant-age').value}
Partner Age: ${document.getElementById('partner-age').value || 'N/A'}
Interest Rate: ${document.getElementById('interest-rate').value}%

Results:
Total Released: ${totalReleased}
Projected Final Debt: ${finalDebt}
Inheritance Value: ${document.getElementById('inheritance-value').textContent}
LTV Ratio: ${document.getElementById('ltv-ratio').textContent}

Drawdown Schedule:
Initial Drawdown: £${document.getElementById('initial-drawdown').value}
Year ${document.getElementById('drawdown-year-1').value || 'N/A'}: £${document.getElementById('drawdown-amount-1').value || '0'}
Year ${document.getElementById('drawdown-year-2').value || 'N/A'}: £${document.getElementById('drawdown-amount-2').value || '0'}

Generated on: ${new Date().toLocaleDateString()}

Visit our Equity Release Calculator for more analysis!
        `;
        
        const blob = new Blob([results], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `equity-release-calculation-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        console.log('Results saved successfully');
    } catch (error) {
        console.error('Error saving results:', error);
        alert('Failed to save results. Please try again.');
    }
}

// Clear calculator
function clearCalculator() {
    console.log('Clearing Equity Release calculator...');

    document.getElementById('product-type').value = 'drawdown';
    document.getElementById('property-value').value = '';
    document.getElementById('existing-mortgage').value = '';
    document.getElementById('applicant-age').value = '';
    document.getElementById('partner-age').value = '';
    document.getElementById('initial-drawdown').value = '';
    document.getElementById('interest-rate').value = '';
    document.getElementById('drawdown-year-1').value = '';
    document.getElementById('drawdown-amount-1').value = '';
    document.getElementById('drawdown-year-2').value = '';
    document.getElementById('drawdown-amount-2').value = '';
    document.getElementById('property-growth').value = '2.5';
    document.getElementById('provider').value = 'aviva';

    // Update displays
    document.getElementById('growth-display').textContent = '2.5%';

    updateVisualization();
    updateFormula();

    // Hide results
    const resultContainer = document.getElementById('result-container');
    if (resultContainer) {
        resultContainer.classList.add('hidden');
    }

    // Destroy chart
    if (projectionChart) {
        projectionChart.destroy();
        projectionChart = null;
    }

    console.log('Equity Release calculator cleared successfully');
}

// Set default values if empty
function setDefaultValues() {
    if (!document.getElementById('property-value').value) {
        document.getElementById('property-value').value = '350000';
        document.getElementById('applicant-age').value = '65';
        document.getElementById('initial-drawdown').value = '50000';
        document.getElementById('interest-rate').value = '5.5';
    }
}

// Ensure DOM is fully loaded before initializing
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing Equity Release calculator...');
        setDefaultValues();
        initCalculator();
        lucide.createIcons();
        
        // Render KaTeX formulas
        setTimeout(() => {
            try {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false}
                    ]
                });
            } catch (e) {
                console.error('Error rendering math:', e);
            }
        }, 100);
    });
} else {
    console.log('DOM already loaded, initializing Equity Release calculator...');
    setDefaultValues();
    initCalculator();
    lucide.createIcons();
    
    // Render KaTeX formulas
    setTimeout(() => {
        try {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ]
            });
        } catch (e) {
            console.error('Error rendering math:', e);
        }
    }, 100);
}
</script>
{% endblock %}