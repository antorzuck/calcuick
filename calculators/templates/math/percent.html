{% extends 'base.html' %}
{% block title %}{{c.name}}{% endblock %}
{% block description %}{{c.description}}{% endblock %}

{% block og_title %}{{c.title}}{% endblock %}
{% block og_description %}{{c.description}}{% endblock %}

{% block twitter_title %}{{c.title}}{% endblock %}
{% block twitter_description %}{{c.description}}{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
  
    <style>
        .calculation-card {
            transition: all 0.3s ease;
        }
        .recovery-display {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        }
        .insight-card {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
        }
        .dark .insight-card {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        }
        .parameter-input {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,250,252,0.9) 100%);
        }
        .dark .parameter-input {
            background: linear-gradient(135deg, rgba(55,65,81,0.9) 0%, rgba(75,85,99,0.9) 100%);
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .chemistry-quote {
            font-style: italic;
            position: relative;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
            border-left: 4px solid #1e40af;
            border-radius: 0 8px 8px 0;
        }
        .recovery-meter {
            background: linear-gradient(90deg, #ef4444 0%, #f59e0b 25%, #eab308 50%, #22c55e 75%, #10b981 100%);
            height: 8px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }
        .recovery-indicator {
            position: absolute;
            top: -2px;
            width: 4px;
            height: 12px;
            background: white;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: left 0.5s ease;
        }
        .procedure-visualization {
            width: 250px;
            height: 250px;
            border: 2px solid #1e40af;
            border-radius: 20px;
            position: relative;
            margin: 0 auto;
            background: radial-gradient(circle, rgba(30, 64, 175, 0.1) 0%, rgba(30, 64, 175, 0.05) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .sample-particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: float 4s ease-in-out infinite;
        }
        .recovered {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        .lost {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
            opacity: 0.6;
        }
        .theoretical {
            background: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) translateX(0px); }
            25% { transform: translateY(-8px) translateX(3px); }
            50% { transform: translateY(0px) translateX(-3px); }
            75% { transform: translateY(8px) translateX(2px); }
        }
        .formula-box {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
        }
        .dark .formula-box {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-color: #475569;
        }
        .procedure-card {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #bfdbfe;
            transition: all 0.3s ease;
        }
        .dark .procedure-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            border-color: #3b82f6;
        }
        .procedure-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
        }
        .efficiency-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        .excellent { background: #10b981; }
        .good { background: #22c55e; }
        .fair { background: #eab308; }
        .poor { background: #ef4444; }
        .temperature-scale {
            background: linear-gradient(90deg, #3b82f6 0%, #1e40af 50%, #1e3a8a 100%);
            height: 6px;
            border-radius: 3px;
            position: relative;
        }
    </style>
{% endblock %}


{% block body %}
    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- Back Button -->
        <div class="mb-6">
            <button onclick="window.history.back()" class="flex items-center space-x-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                <span>Back to Calculators</span>
            </button>
        </div>

        <!-- Header -->
        <div class="text-center mb-12">
            <div class="w-16 h-16 bg-blue-50 dark:bg-blue-900/30 rounded-xl flex items-center justify-center mx-auto mb-6 pulse-animation">
                <i data-lucide="flask-conical" class="w-8 h-8 text-blue-600 dark:text-blue-400"></i>
            </div>
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white mb-4">Percent Recovery Calculator</h1>
            <p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
                Calculate percent recovery for analytical procedures and chemical processes. Essential for quality control and method validation!
            </p>
            <div class="mt-4 bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg inline-block">
                <div class="text-blue-800 dark:text-blue-300 font-medium">
                    üß™ Analytical Chemistry ‚Ä¢ ‚öóÔ∏è Quality Control ‚Ä¢ üìä Method Validation
                </div>
            </div>
        </div>

        <!-- Calculator -->
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-8 shadow-lg">
            <!-- Input Section -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">Recovery Parameters</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Input Controls -->
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Procedure Type:</label>
                            <select id="procedure-type" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="extraction">Liquid-Liquid Extraction</option>
                                <option value="crystallization">Crystallization</option>
                                <option value="distillation">Distillation</option>
                                <option value="precipitation">Precipitation</option>
                                <option value="synthesis">Organic Synthesis</option>
                                <option value="purification">Purification</option>
                                <option value="spe">Solid Phase Extraction</option>
                                <option value="chromatography">Column Chromatography</option>
                                <option value="custom">Custom Procedure</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sample Type:</label>
                            <select id="sample-type" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="organic">Organic Compound</option>
                                <option value="inorganic">Inorganic Salt</option>
                                <option value="pharmaceutical">Pharmaceutical</option>
                                <option value="natural-product">Natural Product</option>
                                <option value="polymer">Polymer</option>
                                <option value="metal">Metal/Alloy</option>
                                <option value="environmental">Environmental Sample</option>
                                <option value="biological">Biological Sample</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Actual Yield:</label>
                                <input type="number" id="actual-yield" step="0.001" placeholder="0.850" 
                                       class="parameter-input w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Amount recovered</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Theoretical Yield:</label>
                                <input type="number" id="theoretical-yield" step="0.001" placeholder="1.000" 
                                       class="parameter-input w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Expected amount</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Units:</label>
                                <select id="units" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="g">Grams (g)</option>
                                    <option value="mg">Milligrams (mg)</option>
                                    <option value="kg">Kilograms (kg)</option>
                                    <option value="mol">Moles (mol)</option>
                                    <option value="mmol">Millimoles (mmol)</option>
                                    <option value="mL">Milliliters (mL)</option>
                                    <option value="L">Liters (L)</option>
                                    <option value="ppm">Parts per million (ppm)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Temperature (¬∞C):</label>
                                <input type="number" id="temperature" step="0.1" placeholder="25.0" 
                                       class="parameter-input w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg">
                            </div>
                        </div>

                        <!-- Experimental Conditions -->
                        <div id="experimental-section">
                            <h3 class="font-medium text-gray-900 dark:text-white mb-3">Experimental Conditions</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">pH (if applicable):</label>
                                    <input type="number" id="ph-value" step="0.1" min="0" max="14" placeholder="7.0" 
                                           class="parameter-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Reaction Time (min):</label>
                                    <input type="number" id="reaction-time" step="1" placeholder="60" 
                                           class="parameter-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                            </div>
                        </div>

                        <!-- Custom Procedure Section -->
                        <div id="custom-procedure-section" class="hidden">
                            <h3 class="font-medium text-gray-900 dark:text-white mb-3">Custom Procedure Details</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Expected Recovery Range (%):</label>
                                    <input type="text" id="expected-range" placeholder="80-95%" 
                                           class="parameter-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 dark:text-gray-300 mb-1">Procedure Notes:</label>
                                    <textarea id="procedure-notes" rows="2" placeholder="Describe your custom procedure..." 
                                              class="parameter-input w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Presets -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Quick Presets:</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setPreset('extraction-good')" class="px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-sm hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">
                                    Good Extraction
                                </button>
                                <button onclick="setPreset('crystallization-excellent')" class="px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-sm hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">
                                    Excellent Crystal
                                </button>
                                <button onclick="setPreset('synthesis-fair')" class="px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-sm hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">
                                    Fair Synthesis
                                </button>
                                <button onclick="setPreset('purification-poor')" class="px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg text-sm hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-colors">
                                    Poor Recovery
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visual Representation -->
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4 text-center">Recovery Visualization</h3>
                            <div class="procedure-visualization" id="procedure-viz">
                                <!-- Particles will be generated here -->
                            </div>
                            <div class="text-center mt-4">
                                <span id="efficiency-display" class="text-lg font-semibold text-blue-600 dark:text-blue-400 flex items-center justify-center">
                                    <span class="efficiency-indicator good"></span>
                                    Good Recovery
                                </span>
                            </div>
                        </div>
                        
                        <!-- Recovery Meter -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-3 text-center">Recovery Meter</h4>
                            <div class="recovery-meter">
                                <div class="recovery-indicator" id="recovery-indicator" style="left: 75%;"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mt-2">
                                <span>0%</span>
                                <span>25%</span>
                                <span>50%</span>
                                <span>75%</span>
                                <span>100%</span>
                            </div>
                        </div>
                        
                        <!-- Formula Display -->
                        <div class="formula-box">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Recovery Formula:</h4>
                            <div id="formula-display" class="text-sm text-gray-700 dark:text-gray-300">
                                <div id="katex-formula"></div>
                            </div>
                        </div>
                        
                        <!-- Procedure Properties -->
                        <div class="procedure-card p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-2">Procedure Properties:</h4>
                            <div id="procedure-info" class="text-sm text-gray-700 dark:text-gray-300">
                                Typical Range: 70-90% ‚Ä¢ Type: Separation ‚Ä¢ Difficulty: Moderate
                            </div>
                        </div>

                        <!-- Standards Display -->
                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-900 dark:text-white mb-3 text-center">Recovery Standards</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Excellent:</span>
                                    <span class="font-medium text-green-600">95-100%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Good:</span>
                                    <span class="font-medium text-blue-600">80-95%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Fair:</span>
                                    <span class="font-medium text-yellow-600">70-80%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600 dark:text-gray-400">Poor:</span>
                                    <span class="font-medium text-red-600">&lt;70%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 mb-8">
                <button id="calculate-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-2">
                    <i data-lucide="calculator" class="w-5 h-5"></i>
                    <span>Calculate Recovery</span>
                </button>
                <button id="clear-btn" class="flex-1 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 py-3 px-6 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-2">
                    <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                    <span>Clear</span>
                </button>
                <button id="save-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center space-x-2">
                    <i data-lucide="download" class="w-5 h-5"></i>
                    <span>Save Results</span>
                </button>
            </div>

            <!-- Results -->
            <div id="result-container" class="hidden">
                <!-- Recovery Summary -->
                <div class="recovery-display text-white rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center space-x-2">
                        <span>Recovery Analysis Results</span>
                        <i data-lucide="target" class="w-5 h-5"></i>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="text-center">
                            <div id="percent-recovery" class="text-3xl font-bold mb-2">-</div>
                            <div class="text-sm opacity-90">Percent Recovery (%)</div>
                        </div>
                        <div class="text-center">
                            <div id="recovery-grade" class="text-3xl font-bold mb-2">-</div>
                            <div class="text-sm opacity-90">Recovery Grade</div>
                        </div>
                        <div class="text-center">
                            <div id="amount-lost" class="text-3xl font-bold mb-2">-</div>
                            <div class="text-sm opacity-90">Amount Lost</div>
                        </div>
                        <div class="text-center">
                            <div id="efficiency-score" class="text-3xl font-bold mb-2">-</div>
                            <div class="text-sm opacity-90">Efficiency Score</div>
                        </div>
                    </div>
                </div>

                <!-- Recovery Analysis -->
                <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-green-800 dark:text-green-300 mb-4 flex items-center space-x-2">
                        <i data-lucide="trending-up" class="w-5 h-5"></i>
                        <span>Recovery Analysis</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                                <span class="font-medium text-gray-900 dark:text-white">Actual Yield:</span>
                                <span id="display-actual" class="font-semibold text-green-600 dark:text-green-400">-</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                                <span class="font-medium text-gray-900 dark:text-white">Theoretical Yield:</span>
                                <span id="display-theoretical" class="font-semibold text-green-600 dark:text-green-400">-</span>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                                <span class="font-medium text-gray-900 dark:text-white">Loss Percentage:</span>
                                <span id="loss-percentage" class="font-semibold text-green-600 dark:text-green-400">-</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-700 rounded-lg">
                                <span class="font-medium text-gray-900 dark:text-white">Recovery Efficiency:</span>
                                <span id="recovery-efficiency" class="font-semibold text-green-600 dark:text-green-400">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Chart -->
                <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-orange-800 dark:text-orange-300 mb-4 flex items-center space-x-2">
                        <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                        <span>Recovery Comparison</span>
                    </h3>
                    <div class="h-64">
                        <canvas id="recovery-chart"></canvas>
                    </div>
                </div>

                <!-- Chemistry Quote -->
                <div class="chemistry-quote mb-6">
                    <p id="chemistry-quote" class="text-gray-800 dark:text-gray-200 text-center">
                        "Percent recovery is the ultimate measure of analytical method efficiency and precision."
                    </p>
                    <p class="text-right text-sm text-gray-600 dark:text-gray-400 mt-2">- Analytical Chemistry Principle</p>
                </div>

                <!-- Chemical Insights -->
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-yellow-800 dark:text-yellow-300 mb-4 flex items-center space-x-2">
                        <i data-lucide="microscope" class="w-5 h-5"></i>
                        <span>Analytical Insights</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="insight-card p-4 rounded-lg">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center space-x-2">
                                <i data-lucide="zap" class="w-4 h-4"></i>
                                <span>Method Performance</span>
                            </h4>
                            <p id="method-performance" class="text-gray-800 dark:text-gray-200">-</p>
                        </div>
                        <div class="insight-card p-4 rounded-lg">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center space-x-2">
                                <i data-lucide="activity" class="w-4 h-4"></i>
                                <span>Loss Sources</span>
                            </h4>
                            <p id="loss-sources" class="text-gray-800 dark:text-gray-200">-</p>
                        </div>
                        <div class="insight-card p-4 rounded-lg">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center space-x-2">
                                <i data-lucide="trending-up" class="w-4 h-4"></i>
                                <span>Improvement Tips</span>
                            </h4>
                            <p id="improvement-tips" class="text-gray-800 dark:text-gray-200">-</p>
                        </div>
                        <div class="insight-card p-4 rounded-lg">
                            <h4 class="font-medium text-gray-900 dark:text-white mb-2 flex items-center space-x-2">
                                <i data-lucide="flask-round" class="w-4 h-4"></i>
                                <span>Applications</span>
                            </h4>
                            <p id="applications" class="text-gray-800 dark:text-gray-200">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Educational Content -->
        <div class="mt-12 bg-gray-50 dark:bg-gray-800/50 rounded-xl p-8">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6 flex items-center space-x-2">
                <i data-lucide="book-open" class="w-6 h-6"></i>
                <span>Percent Recovery Guide</span>
            </h2>
            <div class="space-y-6">
                <div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-2">What is Percent Recovery?</h3>
                    <p class="text-gray-600 dark:text-gray-300 mb-2">
                        Percent recovery measures the efficiency of an analytical procedure: <span class="katex-formula">\text{Recovery} = \frac{\text{Actual Yield}}{\text{Theoretical Yield}} \times 100\%</span>
                    </p>
                    <p class="text-gray-600 dark:text-gray-300">
                        It indicates how much of the target analyte was successfully recovered from the sample.
                    </p>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Recovery Standards</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-600 dark:text-gray-300 text-sm">
                        <li><strong>Excellent Recovery (95-100%):</strong> Outstanding method performance</li>
                        <li><strong>Good Recovery (80-95%):</strong> Acceptable for most analytical methods</li>
                        <li><strong>Fair Recovery (70-80%):</strong> May need optimization</li>
                        <li><strong>Poor Recovery (&lt;70%):</strong> Method requires significant improvement</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Common Procedures and Expected Recoveries</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-600 dark:text-gray-300">
                        <li><strong>Liquid-Liquid Extraction:</strong> 70-90%</li>
                        <li><strong>Solid Phase Extraction:</strong> 80-95%</li>
                        <li><strong>Crystallization:</strong> 60-85%</li>
                        <li><strong>Distillation:</strong> 75-95%</li>
                        <li><strong>Column Chromatography:</strong> 65-90%</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Factors Affecting Recovery</h3>
                    <ul class="list-disc list-inside space-y-1 text-gray-600 dark:text-gray-300">
                        <li>Sample matrix complexity</li>
                        <li>Analyte stability and volatility</li>
                        <li>Extraction/separation efficiency</li>
                        <li>Instrumental limitations</li>
                        <li>Operator technique and experience</li>
                        <li>Environmental conditions (temperature, pH)</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script>
        // Procedure data with properties
        const procedures = {
            extraction: {
                name: 'Liquid-Liquid Extraction',
                type: 'Separation',
                typicalRange: '70-90%',
                difficulty: 'Moderate',
                info: 'Typical Range: 70-90% ‚Ä¢ Type: Separation ‚Ä¢ Difficulty: Moderate'
            },
            crystallization: {
                name: 'Crystallization',
                type: 'Purification',
                typicalRange: '60-85%',
                difficulty: 'Moderate',
                info: 'Typical Range: 60-85% ‚Ä¢ Type: Purification ‚Ä¢ Difficulty: Moderate'
            },
            distillation: {
                name: 'Distillation',
                type: 'Separation',
                typicalRange: '75-95%',
                difficulty: 'Easy',
                info: 'Typical Range: 75-95% ‚Ä¢ Type: Separation ‚Ä¢ Difficulty: Easy'
            },
            precipitation: {
                name: 'Precipitation',
                type: 'Synthesis',
                typicalRange: '80-95%',
                difficulty: 'Easy',
                info: 'Typical Range: 80-95% ‚Ä¢ Type: Synthesis ‚Ä¢ Difficulty: Easy'
            },
            synthesis: {
                name: 'Organic Synthesis',
                type: 'Reaction',
                typicalRange: '50-90%',
                difficulty: 'Hard',
                info: 'Typical Range: 50-90% ‚Ä¢ Type: Reaction ‚Ä¢ Difficulty: Hard'
            },
            purification: {
                name: 'Purification',
                type: 'Cleanup',
                typicalRange: '65-90%',
                difficulty: 'Moderate',
                info: 'Typical Range: 65-90% ‚Ä¢ Type: Cleanup ‚Ä¢ Difficulty: Moderate'
            },
            spe: {
                name: 'Solid Phase Extraction',
                type: 'Separation',
                typicalRange: '80-95%',
                difficulty: 'Easy',
                info: 'Typical Range: 80-95% ‚Ä¢ Type: Separation ‚Ä¢ Difficulty: Easy'
            },
            chromatography: {
                name: 'Column Chromatography',
                type: 'Separation',
                typicalRange: '65-90%',
                difficulty: 'Moderate',
                info: 'Typical Range: 65-90% ‚Ä¢ Type: Separation ‚Ä¢ Difficulty: Moderate'
            },
            custom: {
                name: 'Custom Procedure',
                type: 'Variable',
                typicalRange: '70-100%',
                difficulty: 'Variable',
                info: 'Custom procedure properties'
            }
        };

        // Chemistry quotes for different recovery ranges
        const chemistryQuotes = [
            { min: 95, quote: "Excellent recovery demonstrates mastery of analytical technique and method optimization.", author: "Analytical Excellence" },
            { min: 80, quote: "Good recovery indicates reliable analytical performance and acceptable method validation.", author: "Quality Assurance" },
            { min: 70, quote: "Fair recovery suggests room for method improvement and optimization opportunities.", author: "Method Development" },
            { min: 0, quote: "Poor recovery requires immediate attention to experimental design and technique.", author: "Troubleshooting Guide" }
        ];

        // Preset configurations
        const presets = {
            'extraction-good': {
                procedure: 'extraction',
                sample: 'organic',
                actualYield: 0.850,
                theoreticalYield: 1.000,
                units: 'g',
                temperature: 25,
                ph: 7.0,
                time: 30
            },
            'crystallization-excellent': {
                procedure: 'crystallization',
                sample: 'pharmaceutical',
                actualYield: 0.950,
                theoreticalYield: 1.000,
                units: 'g',
                temperature: 4,
                ph: null,
                time: 120
            },
            'synthesis-fair': {
                procedure: 'synthesis',
                sample: 'organic',
                actualYield: 0.750,
                theoreticalYield: 1.000,
                units: 'g',
                temperature: 80,
                ph: null,
                time: 240
            },
            'purification-poor': {
                procedure: 'purification',
                sample: 'natural-product',
                actualYield: 0.650,
                theoreticalYield: 1.000,
                units: 'mg',
                temperature: 25,
                ph: 8.5,
                time: 90
            }
        };

        let recoveryChart = null;

        // Initialize calculator
        function initCalculator() {
            console.log('Initializing Percent Recovery Calculator...');
            setupEventListeners();
            updateProcedureInputs();
            updateVisualization();
            updateFormula();
            clearCalculator();
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            const calculateBtn = document.getElementById('calculate-btn');
            const clearBtn = document.getElementById('clear-btn');
            const saveBtn = document.getElementById('save-btn');
            const procedureSelect = document.getElementById('procedure-type');

            if (calculateBtn) {
                calculateBtn.addEventListener('click', calculateRecovery);
            }

            if (clearBtn) {
                clearBtn.addEventListener('click', clearCalculator);
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', saveResults);
            }

            if (procedureSelect) {
                procedureSelect.addEventListener('change', () => {
                    updateProcedureInputs();
                    updateVisualization();
                    if (hasValidInputs()) {
                        calculateRecovery();
                    }
                });
            }

            // Add input listeners for real-time updates
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('parameter-input')) {
                    if (hasValidInputs()) {
                        calculateRecovery();
                    }
                }
            });
        }

        // Check if we have valid inputs
        function hasValidInputs() {
            const actualYield = parseFloat(document.getElementById('actual-yield').value);
            const theoreticalYield = parseFloat(document.getElementById('theoretical-yield').value);
            
            return actualYield >= 0 && theoreticalYield > 0;
        }

        // Set preset values
        function setPreset(presetKey) {
            const preset = presets[presetKey];
            if (!preset) return;

            document.getElementById('procedure-type').value = preset.procedure;
            document.getElementById('sample-type').value = preset.sample;
            document.getElementById('actual-yield').value = preset.actualYield;
            document.getElementById('theoretical-yield').value = preset.theoreticalYield;
            document.getElementById('units').value = preset.units;
            document.getElementById('temperature').value = preset.temperature;
            if (preset.ph) document.getElementById('ph-value').value = preset.ph;
            if (preset.time) document.getElementById('reaction-time').value = preset.time;

            updateProcedureInputs();
            updateVisualization();
            updateFormula();
            calculateRecovery();
        }

        // Update input sections based on procedure type
        function updateProcedureInputs() {
            const procedureType = document.getElementById('procedure-type').value;
            const customSection = document.getElementById('custom-procedure-section');

            if (procedureType === 'custom') {
                customSection.classList.remove('hidden');
            } else {
                customSection.classList.add('hidden');
            }
        }

        // Update visualization
        function updateVisualization() {
            const procedureKey = document.getElementById('procedure-type').value;
            const procedure = procedures[procedureKey];
            
            // Update efficiency display
            const efficiencyDisplay = document.getElementById('efficiency-display');
            const typeInfo = {
                'Easy': { name: 'Easy Procedure', class: 'excellent' },
                'Moderate': { name: 'Moderate Procedure', class: 'good' },
                'Hard': { name: 'Challenging Procedure', class: 'fair' },
                'Variable': { name: 'Variable Procedure', class: 'good' }
            };
            
            const info = typeInfo[procedure.difficulty];
            efficiencyDisplay.innerHTML = `
                <span class="efficiency-indicator ${info.class}"></span>
                ${info.name}
            `;

            // Update procedure info
            const procedureInfo = document.getElementById('procedure-info');
            procedureInfo.textContent = procedure.info;

            // Generate particles in visualization
            generateParticles(procedure);
        }

        // Generate particles for visualization
        function generateParticles(procedure) {
            const container = document.getElementById('procedure-viz');
            container.innerHTML = '';

            // Estimate recovery based on procedure type
            let estimatedRecovery = 0.85; // Default
            if (procedure.typicalRange) {
                const range = procedure.typicalRange.split('-');
                const min = parseInt(range[0]);
                const max = parseInt(range[1].replace('%', ''));
                estimatedRecovery = (min + max) / 200; // Average as decimal
            }

            const totalParticles = 20;
            const recoveredParticles = Math.floor(totalParticles * estimatedRecovery);
            const lostParticles = totalParticles - recoveredParticles;

            // Generate recovered particles
            for (let i = 0; i < recoveredParticles; i++) {
                const particle = document.createElement('div');
                particle.className = 'sample-particle recovered';
                
                const x = Math.random() * 220 + 15;
                const y = Math.random() * 220 + 15;
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.animationDelay = `${Math.random() * 4}s`;
                
                container.appendChild(particle);
            }

            // Generate lost particles
            for (let i = 0; i < lostParticles; i++) {
                const particle = document.createElement('div');
                particle.className = 'sample-particle lost';
                
                const x = Math.random() * 220 + 15;
                const y = Math.random() * 220 + 15;
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.animationDelay = `${Math.random() * 4}s`;
                
                container.appendChild(particle);
            }
        }

        // Update formula display
        function updateFormula() {
            const katexElement = document.getElementById('katex-formula');
            const formula = '\\text{Recovery} = \\frac{\\text{Actual Yield}}{\\text{Theoretical Yield}} \\times 100\\%';

            try {
                katex.render(formula, katexElement, {
                    throwOnError: false,
                    displayMode: false
                });
            } catch (error) {
                katexElement.textContent = 'Recovery = (Actual Yield / Theoretical Yield) √ó 100%';
            }
        }

        // Calculate percent recovery
        function calculateRecovery() {
            console.log('Calculating percent recovery...');
            try {
                const actualYield = parseFloat(document.getElementById('actual-yield').value) || 0;
                const theoreticalYield = parseFloat(document.getElementById('theoretical-yield').value) || 0;
                const units = document.getElementById('units').value;
                const procedureKey = document.getElementById('procedure-type').value;
                const temperature = parseFloat(document.getElementById('temperature').value) || 25;

                if (theoreticalYield <= 0) {
                    console.log('Please enter valid theoretical yield');
                    return;
                }

                const procedure = procedures[procedureKey];

                // Calculate percent recovery
                const percentRecovery = (actualYield / theoreticalYield) * 100;
                const amountLost = theoreticalYield - actualYield;
                const lossPercentage = (amountLost / theoreticalYield) * 100;

                // Determine grade and efficiency
                const { grade, efficiency } = getRecoveryGrade(percentRecovery);
                
                // Calculate insights
                const insights = calculateAnalyticalInsights(percentRecovery, procedure, actualYield, theoreticalYield);

                // Update display
                updateResults(percentRecovery, grade, efficiency, actualYield, theoreticalYield, amountLost, lossPercentage, units, insights);

                // Update recovery meter
                updateRecoveryMeter(percentRecovery);

                // Create chart
                createRecoveryChart(percentRecovery, procedure);

                // Show results
                const resultContainer = document.getElementById('result-container');
                resultContainer.classList.remove('hidden');

                setTimeout(() => {
                    resultContainer.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }, 100);

                console.log('Percent recovery calculated successfully:', percentRecovery);
            } catch (error) {
                console.error('Error calculating percent recovery:', error);
                alert('An error occurred while calculating. Please check your inputs.');
            }
        }

        // Get recovery grade and efficiency
        function getRecoveryGrade(percentRecovery) {
            if (percentRecovery >= 95) {
                return { grade: 'Excellent', efficiency: 'A+' };
            } else if (percentRecovery >= 80) {
                return { grade: 'Good', efficiency: 'B+' };
            } else if (percentRecovery >= 70) {
                return { grade: 'Fair', efficiency: 'C+' };
            } else {
                return { grade: 'Poor', efficiency: 'D' };
            }
        }

        // Calculate analytical insights
        function calculateAnalyticalInsights(percentRecovery, procedure, actualYield, theoreticalYield) {
            let methodPerformance = '';
            if (percentRecovery >= 95) {
                methodPerformance = 'Excellent method performance with minimal losses. Outstanding analytical technique.';
            } else if (percentRecovery >= 80) {
                methodPerformance = 'Good method performance within acceptable limits. Reliable analytical results.';
            } else if (percentRecovery >= 70) {
                methodPerformance = 'Fair method performance. Consider optimization to improve recovery.';
            } else {
                methodPerformance = 'Poor method performance. Significant optimization required.';
            }

            let lossSources = '';
            if (percentRecovery < 70) {
                lossSources = 'Major losses likely from incomplete extraction, volatilization, or procedural errors.';
            } else if (percentRecovery < 85) {
                lossSources = 'Moderate losses from sample handling, transfer steps, or matrix effects.';
            } else {
                lossSources = 'Minimal losses indicating good technique and optimized conditions.';
            }

            let improvementTips = '';
            if (percentRecovery < 80) {
                improvementTips = 'Optimize extraction conditions, minimize transfer steps, use internal standards.';
            } else if (percentRecovery < 95) {
                improvementTips = 'Fine-tune method parameters, improve sample preparation techniques.';
            } else {
                improvementTips = 'Excellent recovery achieved. Maintain current methodology and conditions.';
            }

            const applications = 'Quality control, method validation, pharmaceutical analysis, environmental monitoring.';

            return {
                methodPerformance,
                lossSources,
                improvementTips,
                applications
            };
        }

        // Update recovery meter
        function updateRecoveryMeter(percentRecovery) {
            const indicator = document.getElementById('recovery-indicator');
            const position = Math.min(Math.max(percentRecovery, 0), 100);
            indicator.style.left = `${position}%`;
        }

        // Update results display
        function updateResults(percentRecovery, grade, efficiency, actualYield, theoreticalYield, amountLost, lossPercentage, units, insights) {
            // Update summary
            document.getElementById('percent-recovery').textContent = `${percentRecovery.toFixed(2)}%`;
            document.getElementById('recovery-grade').textContent = grade;
            document.getElementById('amount-lost').textContent = `${Math.abs(amountLost).toFixed(3)} ${units}`;
            document.getElementById('efficiency-score').textContent = efficiency;

            // Update analysis
            document.getElementById('display-actual').textContent = `${actualYield.toFixed(3)} ${units}`;
            document.getElementById('display-theoretical').textContent = `${theoreticalYield.toFixed(3)} ${units}`;
            document.getElementById('loss-percentage').textContent = `${Math.abs(lossPercentage).toFixed(2)}%`;
            document.getElementById('recovery-efficiency').textContent = `${percentRecovery.toFixed(1)}%`;

            // Update insights
            document.getElementById('method-performance').textContent = insights.methodPerformance;
            document.getElementById('loss-sources').textContent = insights.lossSources;
            document.getElementById('improvement-tips').textContent = insights.improvementTips;
            document.getElementById('applications').textContent = insights.applications;

            // Update chemistry quote
            const quote = getChemistryQuote(percentRecovery);
            document.getElementById('chemistry-quote').textContent = `"${quote.quote}"`;
            document.querySelector('.chemistry-quote p:last-child').textContent = `- ${quote.author}`;
        }

        // Get chemistry quote based on recovery percentage
        function getChemistryQuote(percentRecovery) {
            for (const quote of chemistryQuotes) {
                if (percentRecovery >= quote.min) {
                    return quote;
                }
            }
            return chemistryQuotes[chemistryQuotes.length - 1];
        }

        // Create recovery comparison chart
        function createRecoveryChart(percentRecovery, procedure) {
            console.log('Creating recovery chart...');
            try {
                const ctx = document.getElementById('recovery-chart');
                if (!ctx) {
                    throw new Error('Chart canvas not found');
                }

                if (recoveryChart) {
                    recoveryChart.destroy();
                }

                // Extract typical range
                const range = procedure.typicalRange.split('-');
                const minTypical = parseInt(range[0]);
                const maxTypical = parseInt(range[1].replace('%', ''));
                const avgTypical = (minTypical + maxTypical) / 2;

                recoveryChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Your Recovery', 'Typical Min', 'Typical Avg', 'Typical Max'],
                        datasets: [{
                            label: 'Recovery Percentage (%)',
                            data: [percentRecovery, minTypical, avgTypical, maxTypical],
                            backgroundColor: ['#f59e0b', '#ef4444', '#3b82f6', '#10b981'],
                            borderColor: ['#d97706', '#dc2626', '#1d4ed8', '#059669'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Recovery Comparison',
                                color: '#1f2937',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed.y.toFixed(1)}%`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Recovery Percentage (%)',
                                    color: '#374151',
                                    font: { size: 12, weight: '500' }
                                },
                                ticks: {
                                    color: '#6b7280'
                                },
                                grid: {
                                    color: '#e5e7eb'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Comparison Type',
                                    color: '#374151',
                                    font: { size: 12, weight: '500' }
                                },
                                ticks: {
                                    color: '#6b7280'
                                },
                                grid: {
                                    color: '#e5e7eb'
                                }
                            }
                        }
                    }
                });

                console.log('Recovery chart created successfully');
            } catch (error) {
                console.error('Error creating recovery chart:', error);
            }
        }

        // Save results function
        function saveResults() {
            try {
                const percentRecovery = document.getElementById('percent-recovery').textContent;
                const procedure = document.getElementById('procedure-type').selectedOptions[0].text;
                const actualYield = document.getElementById('actual-yield').value;
                const theoreticalYield = document.getElementById('theoretical-yield').value;
                const units = document.getElementById('units').value;
                
                const results = `
Percent Recovery Calculator Results
==================================

Procedure Parameters:
Procedure Type: ${procedure}
Sample Type: ${document.getElementById('sample-type').selectedOptions[0].text}
Actual Yield: ${actualYield} ${units}
Theoretical Yield: ${theoreticalYield} ${units}
Temperature: ${document.getElementById('temperature').value}¬∞C

Results:
Percent Recovery: ${percentRecovery}
Recovery Grade: ${document.getElementById('recovery-grade').textContent}
Amount Lost: ${document.getElementById('amount-lost').textContent}
Efficiency Score: ${document.getElementById('efficiency-score').textContent}

Analysis:
Loss Percentage: ${document.getElementById('loss-percentage').textContent}
Recovery Efficiency: ${document.getElementById('recovery-efficiency').textContent}

Generated on: ${new Date().toLocaleDateString()}

Visit our Percent Recovery Calculator for more calculations!
                `;
                
                const blob = new Blob([results], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `recovery-calculation-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('Results saved successfully');
            } catch (error) {
                console.error('Error saving results:', error);
                alert('Failed to save results. Please try again.');
            }
        }

        // Clear calculator
        function clearCalculator() {
            console.log('Clearing recovery calculator...');

            document.getElementById('procedure-type').value = 'extraction';
            document.getElementById('sample-type').value = 'organic';
            document.getElementById('actual-yield').value = '';
            document.getElementById('theoretical-yield').value = '';
            document.getElementById('units').value = 'g';
            document.getElementById('temperature').value = '25.0';
            document.getElementById('ph-value').value = '';
            document.getElementById('reaction-time').value = '';
            document.getElementById('expected-range').value = '';
            document.getElementById('procedure-notes').value = '';

            updateProcedureInputs();
            updateVisualization();
            updateFormula();

            // Hide results
            const resultContainer = document.getElementById('result-container');
            if (resultContainer) {
                resultContainer.classList.add('hidden');
            }

            // Destroy chart
            if (recoveryChart) {
                recoveryChart.destroy();
                recoveryChart = null;
            }

            // Reset recovery meter
            const indicator = document.getElementById('recovery-indicator');
            indicator.style.left = '0%';

            console.log('Recovery calculator cleared successfully');
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing recovery calculator...');
            initCalculator();
            lucide.createIcons();

            // Render KaTeX formulas
            setTimeout(() => {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false}
                    ]
                });
            }, 100);
        });
    </script>

{% endblock %}